<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Проигрыватель</title>
  <style>
    body {
      background-color: #181818;
      color: white;
      font-family: sans-serif;
      display: flex;
      justify-content: center;
      padding: 20px;
    }
    .container {
      width: 100%;
      max-width: 800px;
      text-align: center;
    }
    video, audio {
      width: 100%;
      max-width: 720px;
      margin-top: 10px;
      border: 2px solid #555;
      border-radius: 10px;
      background: black;
    }
    .back-button {
      margin-top: 15px;
      padding: 10px 20px;
      font-size: 15px;
      background-color: #444;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    .back-button:hover {
      background-color: #666;
    }
    #bitrateGraph {
      margin-top: 10px;
      background: #222;
      border-radius: 8px;
      width: 100%;
      max-width: 720px;
      height: 100px;
    }
    #bitrateAlert {
      margin-top: 10px;
      font-size: 14px;
      color: #ff4444;
      font-weight: bold;
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 id="title">Загрузка...</h1>
    <button class="back-button" onclick="location.href='index.html'">⏴ Назад</button>
    <div id="player"></div>
    <div id="bitrateAlert">⚠ Слабый поток!</div>
    <canvas id="bitrateGraph" width="720" height="100"></canvas>
    <audio id="alertSound" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_2634eebd7d.mp3?filename=alert-7393.mp3" preload="auto"></audio>
  </div>

  <script>
    const params = new URLSearchParams(location.search);
    const title = params.get("name") || "Канал";
    const url = params.get("url");
    const index = parseInt(params.get("index"));
    const playlist = JSON.parse(localStorage.getItem("media_autoload")) || [];

    document.getElementById("title").textContent = title;
    const player = document.createElement(/\.(mp3|aac|m4a|ogg)$/i.test(url) ? "audio" : "video");
    player.src = url;
    player.controls = true;
    player.autoplay = true;
    document.getElementById("player").appendChild(player);

    const canvas = document.getElementById("bitrateGraph");
    const ctx = canvas.getContext("2d");
    const alertBox = document.getElementById("bitrateAlert");
    const alertSound = document.getElementById("alertSound");

    let graphData = [], bitrateHistory = [];
    let lastBuffer = 0, lastCheck = 0;
    let bitrateMin = Infinity, bitrateMax = 0, alertPlayed = false, lowStart = null;
    let maxBitrateDynamic = 500;

    function updateStats() {
      if (!player.buffered || player.readyState < 2) return;

      let buf = 0;
      for (let i = 0; i < player.buffered.length; i++) {
        if (player.currentTime >= player.buffered.start(i) && player.currentTime <= player.buffered.end(i)) {
          buf = player.buffered.end(i) - player.currentTime;
          break;
        }
      }

      const now = Date.now();
      let bitrate = 0;
      if (lastCheck > 0) {
        const delta = buf - lastBuffer;
        const dt = (now - lastCheck) / 1000;
        if (delta > 0 && dt > 0) bitrate = delta * 160;
      }
      lastBuffer = buf;
      lastCheck = now;

      if (bitrate > 0) {
        bitrateHistory.push(bitrate);
        if (bitrateHistory.length > 100) bitrateHistory.shift();
        graphData.push(bitrate);
        if (graphData.length > 100) graphData.shift();

        bitrateMin = Math.min(bitrateMin, bitrate);
        bitrateMax = Math.max(bitrateMax, bitrate);
        const avg = bitrateHistory.reduce((a, b) => a + b, 0) / bitrateHistory.length;
        maxBitrateDynamic = Math.ceil(Math.max(...bitrateHistory, 100) / 100) * 100;
        drawGraph(bitrate, avg);

        if (bitrate < 50) {
          alertBox.style.display = "block";
          alertBox.style.visibility = (now % 1000 < 500) ? "visible" : "hidden";
          if (!alertPlayed) {
            alertSound.play().catch(()=>{});
            alertPlayed = true;
          }
          if (!lowStart) lowStart = now;
          else if (now - lowStart > 10000) location.reload();
        } else {
          alertBox.style.display = "none";
          alertPlayed = false;
          lowStart = null;
        }
      }
    }

    function drawGraph(current, avg) {
      const w = canvas.width, h = canvas.height, max = maxBitrateDynamic;
      ctx.clearRect(0, 0, w, h);
      ctx.font = "10px sans-serif";
      ctx.fillStyle = "#888";
      ctx.strokeStyle = "#333";
      for (let yVal = 100; yVal <= max; yVal += 100) {
        const y = h - (yVal / max) * h;
        ctx.beginPath();
        ctx.moveTo(0, y); ctx.lineTo(w, y); ctx.stroke();
        ctx.fillText(`${yVal}`, 5, y - 2);
      }

      if (graphData.length > 1) {
        const stepX = w / (graphData.length - 1);
        let y = h - (graphData[0] / max) * h;
        ctx.beginPath();
        ctx.moveTo(0, y);
        for (let i = 1; i < graphData.length; i++) {
          const x = i * stepX;
          const y2 = h - (graphData[i] / max) * h;
          ctx.lineTo(x, y);
          ctx.lineTo(x, y2);
          y = y2;
        }
        ctx.strokeStyle = "#00f0ff";
        ctx.lineWidth = 2;
        ctx.stroke();
      }

      ctx.fillStyle = "#ccc";
      ctx.textAlign = "right";
      const yMax = h - (bitrateMax / max) * h;
      const yAvg = h - (avg / max) * h;
      const yMin = h - (bitrateMin / max) * h;
      ctx.fillText(`макс: ${bitrateMax.toFixed(0)}`, w - 5, Math.max(yMax, 12));
      ctx.fillText(`средн: ${avg.toFixed(0)}`, w - 5, Math.max(yAvg, 24));
      ctx.fillText(`мин: ${bitrateMin.toFixed(0)}`, w - 5, Math.min(yMin, h - 6));
    }

    setInterval(updateStats, 1000);
  </script>
</body>
</html>